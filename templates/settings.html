{% extends "base.html" %}

{% block title %}Settings - Uatu Watcher{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Settings</h1>
    <p class="page-description">Configure system preferences and integrations</p>
</div>

<div class="settings-container">
    <div class="settings-nav">
        <ul class="settings-nav-list">
            <li class="settings-nav-item">
                <a href="#general" class="settings-nav-link active" data-section="general">
                    ‚öôÔ∏è General
                </a>
            </li>
            <li class="settings-nav-item">
                <a href="#notifications" class="settings-nav-link" data-section="notifications">
                    üîî Notifications
                </a>
            </li>
            <li class="settings-nav-item">
                <a href="#scraper" class="settings-nav-link" data-section="scraper">
                    üåê Web Scraper
                </a>
            </li>
            <li class="settings-nav-item">
                <a href="#scheduler" class="settings-nav-link" data-section="scheduler">
                    ‚è∞ Scheduler
                </a>
            </li>
            <li class="settings-nav-item">
                <a href="#security" class="settings-nav-link" data-section="security">
                    üîí Security
                </a>
            </li>
            <li class="settings-nav-item">
                <a href="#advanced" class="settings-nav-link" data-section="advanced">
                    üîß Advanced
                </a>
            </li>
        </ul>
    </div>

    <div class="settings-content">
        <!-- General Settings -->
        <div id="general-section" class="settings-section active">
            <h2 class="section-title">General Settings</h2>
            <form class="settings-form" data-autosave="general-settings">
                <div class="form-group">
                    <label class="form-label" for="app-name">Application Name</label>
                    <input type="text" id="app-name" name="app_name" class="form-control" value="Uatu Watcher">
                </div>

                <div class="form-group">
                    <label class="form-label" for="timezone">Timezone</label>
                    <select id="timezone" name="timezone" class="form-control">
                        <option value="UTC" selected>UTC</option>
                        <option value="America/New_York">Eastern Time</option>
                        <option value="America/Chicago">Central Time</option>
                        <option value="America/Denver">Mountain Time</option>
                        <option value="America/Los_Angeles">Pacific Time</option>
                        <option value="Europe/London">London</option>
                        <option value="Europe/Berlin">Berlin</option>
                        <option value="Asia/Tokyo">Tokyo</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label" for="language">Language</label>
                    <select id="language" name="language" class="form-control">
                        <option value="en" selected>English</option>
                        <option value="es">Spanish</option>
                        <option value="fr">French</option>
                        <option value="de">German</option>
                        <option value="ja">Japanese</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label" for="theme">Theme</label>
                    <select id="theme" name="theme" class="form-control">
                        <option value="light" selected>Light</option>
                        <option value="dark">Dark</option>
                        <option value="auto">Auto (System)</option>
                    </select>
                </div>

                <button type="submit" class="btn btn-primary">Save General Settings</button>
            </form>
        </div>

        <!-- Notifications Settings -->
        <div id="notifications-section" class="settings-section">
            <h2 class="section-title">Notification Settings</h2>
            
            <div class="notification-tabs">
                <button class="tab-btn active" data-tab="email">üìß Email</button>
                <button class="tab-btn" data-tab="discord">üí¨ Discord</button>
                <button class="tab-btn" data-tab="webhook">üîó Webhook</button>
            </div>

            <!-- Email Settings -->
            <div id="email-tab" class="tab-content active">
                <form class="settings-form" data-autosave="email-settings">
                    <div class="form-group">
                        <label>
                            <input type="checkbox" name="email_enabled"> Enable Email Notifications
                        </label>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="smtp-host">SMTP Host</label>
                        <input type="text" id="smtp-host" name="smtp_host" class="form-control" placeholder="smtp.gmail.com">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="smtp-port">SMTP Port</label>
                        <input type="number" id="smtp-port" name="smtp_port" class="form-control" value="587">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="smtp-username">Username</label>
                        <input type="text" id="smtp-username" name="smtp_username" class="form-control">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="smtp-password">Password</label>
                        <input type="password" id="smtp-password" name="smtp_password" class="form-control">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="from-email">From Email</label>
                        <input type="email" id="from-email" name="from_email" class="form-control">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="to-email">Default To Email</label>
                        <input type="email" id="to-email" name="to_email" class="form-control">
                    </div>

                    <div class="form-group">
                        <label>
                            <input type="checkbox" name="smtp_tls"> Use TLS/STARTTLS
                        </label>
                    </div>

                    <button type="button" class="btn btn-outline" onclick="testEmailSettings()">Test Email</button>
                    <button type="submit" class="btn btn-primary">Save Email Settings</button>
                </form>
            </div>

            <!-- Discord Settings -->
            <div id="discord-tab" class="tab-content">
                <form class="settings-form" data-autosave="discord-settings">
                    <div class="form-group">
                        <label>
                            <input type="checkbox" name="discord_enabled"> Enable Discord Notifications
                        </label>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="discord-webhook">Webhook URL</label>
                        <input type="url" id="discord-webhook" name="discord_webhook" class="form-control" placeholder="https://discord.com/api/webhooks/...">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="discord-username">Bot Username</label>
                        <input type="text" id="discord-username" name="discord_username" class="form-control" value="Uatu Watcher">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="discord-avatar">Avatar URL (optional)</label>
                        <input type="url" id="discord-avatar" name="discord_avatar" class="form-control">
                    </div>

                    <button type="button" class="btn btn-outline" onclick="testDiscordSettings()">Test Discord</button>
                    <button type="submit" class="btn btn-primary">Save Discord Settings</button>
                </form>
            </div>

            <!-- Webhook Settings -->
            <div id="webhook-tab" class="tab-content">
                <form class="settings-form" data-autosave="webhook-settings">
                    <div class="form-group">
                        <label>
                            <input type="checkbox" name="webhook_enabled"> Enable Webhook Notifications
                        </label>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="webhook-url">Webhook URL</label>
                        <input type="url" id="webhook-url" name="webhook_url" class="form-control">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="webhook-method">HTTP Method</label>
                        <select id="webhook-method" name="webhook_method" class="form-control">
                            <option value="POST" selected>POST</option>
                            <option value="PUT">PUT</option>
                            <option value="PATCH">PATCH</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="webhook-headers">Custom Headers (JSON)</label>
                        <textarea id="webhook-headers" name="webhook_headers" class="form-control" rows="3" placeholder='{"Authorization": "Bearer token"}'></textarea>
                    </div>

                    <button type="button" class="btn btn-outline" onclick="testWebhookSettings()">Test Webhook</button>
                    <button type="submit" class="btn btn-primary">Save Webhook Settings</button>
                </form>
            </div>
        </div>

        <!-- Scraper Settings -->
        <div id="scraper-section" class="settings-section">
            <h2 class="section-title">Web Scraper Settings</h2>
            <form class="settings-form" data-autosave="scraper-settings">
                <div class="form-group">
                    <label class="form-label" for="user-agent">User Agent</label>
                    <input type="text" id="user-agent" name="user_agent" class="form-control" value="Mozilla/5.0 (compatible; UatuWatcher/1.0)">
                </div>

                <div class="form-group">
                    <label class="form-label" for="request-timeout">Request Timeout (seconds)</label>
                    <input type="number" id="request-timeout" name="request_timeout" class="form-control" value="30" min="5" max="300">
                </div>

                <div class="form-group">
                    <label class="form-label" for="max-concurrent">Max Concurrent Requests</label>
                    <input type="number" id="max-concurrent" name="max_concurrent" class="form-control" value="5" min="1" max="20">
                </div>

                <div class="form-group">
                    <label class="form-label" for="retry-attempts">Retry Attempts</label>
                    <input type="number" id="retry-attempts" name="retry_attempts" class="form-control" value="3" min="0" max="10">
                </div>

                <div class="form-group">
                    <label class="form-label" for="retry-delay">Retry Delay (milliseconds)</label>
                    <input type="number" id="retry-delay" name="retry_delay" class="form-control" value="1000" min="100" max="10000">
                </div>

                <div class="form-group">
                    <label class="form-label" for="chrome-path">Chrome Executable Path (optional)</label>
                    <input type="text" id="chrome-path" name="chrome_path" class="form-control" placeholder="/usr/bin/google-chrome">
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" name="headless_mode" checked> Use Headless Mode
                    </label>
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" name="enable_screenshots"> Enable Screenshots
                    </label>
                </div>

                <button type="submit" class="btn btn-primary">Save Scraper Settings</button>
            </form>
        </div>

        <!-- Scheduler Settings -->
        <div id="scheduler-section" class="settings-section">
            <h2 class="section-title">Scheduler Settings</h2>
            <form class="settings-form" data-autosave="scheduler-settings">
                <div class="form-group">
                    <label class="form-label" for="default-interval">Default Check Interval</label>
                    <input type="text" id="default-interval" name="default_interval" class="form-control" value="0 */6 * * *" placeholder="0 */6 * * *">
                    <small class="form-text">Cron expression (e.g., "0 */6 * * *" for every 6 hours)</small>
                </div>

                <div class="form-group">
                    <label class="form-label" for="max-running-jobs">Max Running Jobs</label>
                    <input type="number" id="max-running-jobs" name="max_running_jobs" class="form-control" value="10" min="1" max="100">
                </div>

                <div class="form-group">
                    <label class="form-label" for="job-timeout">Job Timeout (seconds)</label>
                    <input type="number" id="job-timeout" name="job_timeout" class="form-control" value="300" min="30" max="1800">
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" name="auto_start_scheduler" checked> Auto-start Scheduler on Boot
                    </label>
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" name="persist_job_history" checked> Persist Job History
                    </label>
                </div>

                <button type="submit" class="btn btn-primary">Save Scheduler Settings</button>
            </form>
        </div>

        <!-- Security Settings -->
        <div id="security-section" class="settings-section">
            <h2 class="section-title">Security Settings</h2>
            <form class="settings-form" data-autosave="security-settings">
                <div class="form-group">
                    <label class="form-label" for="secret-key">Secret Key (for sessions)</label>
                    <div class="input-group">
                        <input type="password" id="secret-key" name="secret_key" class="form-control">
                        <button type="button" class="btn btn-outline" onclick="generateSecretKey()">Generate New</button>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="session-timeout">Session Timeout (minutes)</label>
                    <input type="number" id="session-timeout" name="session_timeout" class="form-control" value="60" min="5" max="1440">
                </div>

                <div class="form-group">
                    <label class="form-label" for="rate-limit">Rate Limit (requests per minute)</label>
                    <input type="number" id="rate-limit" name="rate_limit" class="form-control" value="100" min="1" max="1000">
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" name="require_https"> Require HTTPS
                    </label>
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" name="enable_cors" checked> Enable CORS
                    </label>
                </div>

                <button type="submit" class="btn btn-primary">Save Security Settings</button>
            </form>
        </div>

        <!-- Advanced Settings -->
        <div id="advanced-section" class="settings-section">
            <h2 class="section-title">Advanced Settings</h2>
            
            <div class="advanced-actions">
                <div class="action-card">
                    <h3>Database Management</h3>
                    <p>Backup, restore, or reset your database.</p>
                    <div class="action-buttons">
                        <button class="btn btn-outline" onclick="backupDatabase()">Backup Database</button>
                        <button class="btn btn-outline" onclick="showRestoreDialog()">Restore Database</button>
                        <button class="btn btn-danger" onclick="resetDatabase()">Reset Database</button>
                    </div>
                </div>

                <div class="action-card">
                    <h3>System Maintenance</h3>
                    <p>Clear caches, logs, and perform system cleanup.</p>
                    <div class="action-buttons">
                        <button class="btn btn-outline" onclick="clearCache()">Clear Cache</button>
                        <button class="btn btn-outline" onclick="clearLogs()">Clear Logs</button>
                        <button class="btn btn-warning" onclick="restartSystem()">Restart System</button>
                    </div>
                </div>

                <div class="action-card">
                    <h3>Import/Export</h3>
                    <p>Import or export your configuration and products.</p>
                    <div class="action-buttons">
                        <button class="btn btn-outline" onclick="exportConfig()">Export Config</button>
                        <button class="btn btn-outline" onclick="showImportDialog()">Import Config</button>
                    </div>
                </div>
            </div>

            <form class="settings-form" data-autosave="advanced-settings">
                <h3>Performance Settings</h3>

                <div class="form-group">
                    <label class="form-label" for="thread-pool-size">Thread Pool Size</label>
                    <input type="number" id="thread-pool-size" name="thread_pool_size" class="form-control" value="4" min="1" max="32">
                </div>

                <div class="form-group">
                    <label class="form-label" for="memory-limit">Memory Limit (MB)</label>
                    <input type="number" id="memory-limit" name="memory_limit" class="form-control" value="512" min="128" max="4096">
                </div>

                <div class="form-group">
                    <label class="form-label" for="log-level">Log Level</label>
                    <select id="log-level" name="log_level" class="form-control">
                        <option value="error">Error</option>
                        <option value="warn">Warning</option>
                        <option value="info" selected>Info</option>
                        <option value="debug">Debug</option>
                        <option value="trace">Trace</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" name="enable_metrics" checked> Enable Metrics Collection
                    </label>
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" name="enable_compression"> Enable Response Compression
                    </label>
                </div>

                <button type="submit" class="btn btn-primary">Save Advanced Settings</button>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Settings page functionality
    
    // Tab navigation
    document.querySelectorAll('.settings-nav-link').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const sectionId = this.dataset.section;
            switchSection(sectionId);
        });
    });

    // Notification tabs
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const tabId = this.dataset.tab;
            switchNotificationTab(tabId);
        });
    });

    function switchSection(sectionId) {
        // Update navigation
        document.querySelectorAll('.settings-nav-link').forEach(link => {
            link.classList.remove('active');
        });
        document.querySelector(`[data-section="${sectionId}"]`).classList.add('active');

        // Update content
        document.querySelectorAll('.settings-section').forEach(section => {
            section.classList.remove('active');
        });
        document.getElementById(`${sectionId}-section`).classList.add('active');
    }

    function switchNotificationTab(tabId) {
        // Update tab buttons
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');

        // Update tab content
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
        });
        document.getElementById(`${tabId}-tab`).classList.add('active');
    }

    // Form submissions
    document.querySelectorAll('.settings-form').forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            saveSettings(this);
        });
    });

    async function saveSettings(form) {
        const formData = new FormData(form);
        const data = {};
        
        for (let [key, value] of formData.entries()) {
            data[key] = value;
        }

        try {
            // In a real implementation, this would save to the server
            FlashMessages.success('Settings saved successfully!');
            
            // Save to local storage as well
            const formId = form.getAttribute('data-autosave');
            if (formId) {
                Storage.set(formId, data);
            }
        } catch (error) {
            FlashMessages.error('Failed to save settings: ' + error.message);
        }
    }

    // Test functions
    async function testEmailSettings() {
        try {
            // In a real implementation, this would send a test email
            FlashMessages.success('Test email sent successfully!');
        } catch (error) {
            FlashMessages.error('Failed to send test email: ' + error.message);
        }
    }

    async function testDiscordSettings() {
        try {
            // In a real implementation, this would send a test Discord message
            FlashMessages.success('Test Discord message sent successfully!');
        } catch (error) {
            FlashMessages.error('Failed to send test Discord message: ' + error.message);
        }
    }

    async function testWebhookSettings() {
        try {
            // In a real implementation, this would send a test webhook
            FlashMessages.success('Test webhook sent successfully!');
        } catch (error) {
            FlashMessages.error('Failed to send test webhook: ' + error.message);
        }
    }

    // Advanced actions
    function generateSecretKey() {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
        let key = '';
        for (let i = 0; i < 32; i++) {
            key += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        document.getElementById('secret-key').value = key;
    }

    async function backupDatabase() {
        try {
            // In a real implementation, this would create a database backup
            FlashMessages.success('Database backup created successfully!');
        } catch (error) {
            FlashMessages.error('Failed to backup database: ' + error.message);
        }
    }

    async function resetDatabase() {
        const confirmed = await confirmAction('This will permanently delete all your data. Are you sure?', 'Reset Database');
        if (confirmed) {
            try {
                // In a real implementation, this would reset the database
                FlashMessages.warning('Database has been reset. All data has been deleted.');
            } catch (error) {
                FlashMessages.error('Failed to reset database: ' + error.message);
            }
        }
    }

    async function clearCache() {
        try {
            // In a real implementation, this would clear system cache
            FlashMessages.success('Cache cleared successfully!');
        } catch (error) {
            FlashMessages.error('Failed to clear cache: ' + error.message);
        }
    }

    async function clearLogs() {
        try {
            // In a real implementation, this would clear log files
            FlashMessages.success('Logs cleared successfully!');
        } catch (error) {
            FlashMessages.error('Failed to clear logs: ' + error.message);
        }
    }

    async function restartSystem() {
        const confirmed = await confirmAction('This will restart the system. Continue?', 'Restart System');
        if (confirmed) {
            FlashMessages.info('System restart initiated...');
            // In a real implementation, this would restart the system
        }
    }

    async function exportConfig() {
        try {
            // In a real implementation, this would generate and download config
            const config = {
                general: Storage.get('general-settings', {}),
                email: Storage.get('email-settings', {}),
                discord: Storage.get('discord-settings', {}),
                webhook: Storage.get('webhook-settings', {}),
                scraper: Storage.get('scraper-settings', {}),
                scheduler: Storage.get('scheduler-settings', {}),
                security: Storage.get('security-settings', {}),
                advanced: Storage.get('advanced-settings', {})
            };

            const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'uatu-watcher-config.json';
            a.click();
            URL.revokeObjectURL(url);

            FlashMessages.success('Configuration exported successfully!');
        } catch (error) {
            FlashMessages.error('Failed to export configuration: ' + error.message);
        }
    }

    function showRestoreDialog() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.sql,.db';
        input.addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (file) {
                try {
                    // In a real implementation, this would restore the database
                    FlashMessages.success(`Database restore initiated from ${file.name}`);
                } catch (error) {
                    FlashMessages.error('Failed to restore database: ' + error.message);
                }
            }
        });
        input.click();
    }

    function showImportDialog() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        input.addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (file) {
                try {
                    const text = await file.text();
                    const config = JSON.parse(text);
                    
                    // Import settings to local storage
                    Object.keys(config).forEach(key => {
                        if (config[key] && typeof config[key] === 'object') {
                            Storage.set(`${key}-settings`, config[key]);
                        }
                    });

                    FlashMessages.success('Configuration imported successfully! Please refresh the page.');
                } catch (error) {
                    FlashMessages.error('Failed to import configuration: ' + error.message);
                }
            }
        });
        input.click();
    }

    // Load saved settings on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Load settings from local storage and populate forms
        document.querySelectorAll('.settings-form').forEach(form => {
            const formId = form.getAttribute('data-autosave');
            if (formId) {
                const savedData = Storage.get(formId, {});
                Object.keys(savedData).forEach(name => {
                    const field = form.querySelector(`[name="${name}"]`);
                    if (field) {
                        if (field.type === 'checkbox') {
                            field.checked = savedData[name] === 'on' || savedData[name] === true;
                        } else {
                            field.value = savedData[name];
                        }
                    }
                });
            }
        });
    });
</script>

<style>
.settings-container {
    display: grid;
    grid-template-columns: 250px 1fr;
    gap: 2rem;
    margin-bottom: 2rem;
}

.settings-nav {
    background-color: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    padding: 1rem;
    height: fit-content;
    position: sticky;
    top: 2rem;
}

.settings-nav-list {
    list-style: none;
    margin: 0;
    padding: 0;
}

.settings-nav-item {
    margin-bottom: 0.5rem;
}

.settings-nav-link {
    display: block;
    padding: 0.75rem 1rem;
    color: var(--text-color);
    text-decoration: none;
    border-radius: var(--border-radius);
    transition: var(--transition);
}

.settings-nav-link:hover,
.settings-nav-link.active {
    background-color: var(--primary-color);
    color: white;
}

.settings-content {
    background-color: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    padding: 2rem;
}

.settings-section {
    display: none;
}

.settings-section.active {
    display: block;
}

.settings-form {
    max-width: 600px;
}

.notification-tabs {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 2rem;
    border-bottom: 1px solid var(--border-color);
}

.tab-btn {
    padding: 0.75rem 1rem;
    background: none;
    border: none;
    border-bottom: 2px solid transparent;
    cursor: pointer;
    transition: var(--transition);
}

.tab-btn.active {
    border-bottom-color: var(--primary-color);
    color: var(--primary-color);
}

.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
}

.form-text {
    color: var(--text-muted);
    font-size: 0.875rem;
}

.input-group {
    display: flex;
    gap: 0.5rem;
}

.input-group .form-control {
    flex: 1;
}

.advanced-actions {
    margin-bottom: 2rem;
}

.action-card {
    background-color: var(--light-color);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    padding: 1.5rem;
    margin-bottom: 1rem;
}

.action-card h3 {
    margin-bottom: 0.5rem;
}

.action-card p {
    color: var(--text-muted);
    margin-bottom: 1rem;
}

.action-buttons {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

@media (max-width: 768px) {
    .settings-container {
        grid-template-columns: 1fr;
    }
    
    .settings-nav {
        position: static;
    }
    
    .settings-nav-list {
        display: flex;
        gap: 0.5rem;
        overflow-x: auto;
    }
    
    .settings-nav-item {
        margin-bottom: 0;
        min-width: fit-content;
    }
}
</style>
{% endblock %}